# HTTPS 细读

## HTTPS 建立

* 建立TCP连接
* 建立SSL/TLS连接

```c
//rfc5246 TSL

      Client                                               Server

      ClientHello                  -------->
                                                      ServerHello
                                                     Certificate*
                                               ServerKeyExchange*
                                              CertificateRequest*
                                   <--------      ServerHelloDone
      Certificate*
      ClientKeyExchange
      CertificateVerify*
      [ChangeCipherSpec]
      Finished                     -------->
                                               [ChangeCipherSpec]
                                   <--------             Finished
      Application Data             <------->     Application Data


struct {
          ProtocolVersion client_version;
          Random random;
          SessionID session_id;
          CipherSuite cipher_suites<2..2^16-2>;
          CompressionMethod compression_methods<1..2^8-1>;
          select (extensions_present) {
              case false:
                  struct {};
              case true:
                  Extension extensions<0..2^16-1>;
          };
      } ClientHello;

struct {
          ProtocolVersion server_version;
          Random random;
          SessionID session_id;
          CipherSuite cipher_suite;
          CompressionMethod compression_method;
          select (extensions_present) {
              case false:
                  struct {};
              case true:
                  Extension extensions<0..2^16-1>;
          };
      } ServerHello;

```

```c

client --> <hello>,<random num1>,<cipher-suites>,<SSL/TLS version> -->server
client >-- <hello>,<random num2>,<matched cipher-suites>,<matched version>-->server
client: 评估服务器证书
client: -->pre_master_secret -->server
client: master_secret  |  server:master_secret


pre_master_secret: 
This `random value` is generated by the client and is used to generate the `master secret`

struct {
          ProtocolVersion client_version;
          opaque random[46];
      } PreMasterSecret;

master secret:
48-byte secret shared between the client and server.

key_block = PRF(SecurityParameters.master_secret,
                      "key expansion",
                      SecurityParameters.server_random +
                      SecurityParameters.client_random);

master_secret = PRF(pre_master_secret, "master secret",
                          ClientHello.random + ServerHello.random)
                          [0..47];

/*
master_secret 通信过程中，对称加密使用的共享key,
由三个随机数计算得来ClientHello.random，ServerHello.random，pre_master_secret

*/
```

## cipher

[K15194](https://support.f5.com/csp/article/K15194)

* Key Exchange: The Key Exchange algorithm is used to negotiate the `session key` used for bulk encryption.

* Authentication: The Authentication algorithm is an `asymmetric` encryption algorithm used to `sign certificates and verify the identity of the server` and, optionally, the client, during the SSL/TLS handshake.

* Bulk Cipher[-Block Cipher Mode*]: The Bulk Cipher is a `symmetric` encryption algorithm used for bulk encryption, which encrypts the secure channel after all security parameters have been agreed upon. This algorithm may include a key length.

> Optional: Block ciphers such as AES and DES may specify a mode of operation such as CBC (Cipher Block Chaining) or GCM (Galois Counter Mode). When not specified for a block cipher, CBC mode is implied.

* MAC (Message Authentication Code): The MAC ensures message integrity by creating a `message digest` or `cryptographic hash` of each message exchanged in the secure channel. This is specified as the hash algorithm to be used with HMAC (Hash-based Message Authentication Code).

> Note: AEAD ciphers such as AES-GCM have built-in message authentication and do not use the cipher suite's MAC during bulk encryption.

### 理解cipher suite

To understand the elements within the `ECDHE-RSA-AES128-CBC-SHA` cipher suite, you can separate them as follows:

* Key Exchange algorithm: `ECDHE` (Elliptic Curve Diffie-Hellman Ephemeral)
* Authentication algorithm: `RSA` (Rivest Shamir Adleman,f5默认)
* Cipher algorithm (including mode): `AES128-CBC` (Advanced Encryption Standard with 128 bit key length operating in Cipher Block Chaining mode)
* Message Authentication Code: `SHA` (Secure Hash Algorithm version 1 (SHA-1))


### F5支持的cipher group

* SSL/TLS version: TLSv1, TLSv1_1, TLSv1_2, SSLv3
* Bulk cipher: RC4, AES, AES-GCM
* Key exchange: ECDHE, DHE (or EDH), RSA